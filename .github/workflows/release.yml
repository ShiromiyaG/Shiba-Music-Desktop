name: Build and Release

on:
  push:
    branches:
      - main
      - master
    paths:
      - 'version.txt'

env:
  QT_VERSION: '6.9.3'
  DISCORD_CLIENT_ID: ${{ secrets.DISCORD_CLIENT_ID }}

jobs:
  create-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write
    outputs:
      version: ${{ steps.version.outputs.version }}
      tag: ${{ steps.version.outputs.tag }}
      tag_exists: ${{ steps.check_tag.outputs.exists }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Read version
      id: version
      run: |
        VERSION=$(cat version.txt | tr -d '\n' | tr -d '\r')
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "tag=v$VERSION" >> $GITHUB_OUTPUT
        echo "üì¶ Version: $VERSION"
    
    - name: Check if tag exists
      id: check_tag
      run: |
        if git rev-parse "v${{ steps.version.outputs.version }}" >/dev/null 2>&1; then
          echo "exists=true" >> $GITHUB_OUTPUT
          echo "‚ö†Ô∏è  Tag v${{ steps.version.outputs.version }} already exists"
        else
          echo "exists=false" >> $GITHUB_OUTPUT
          echo "‚úÖ Tag v${{ steps.version.outputs.version }} is new"
        fi
    
    - name: Create and push tag
      if: steps.check_tag.outputs.exists == 'false'
      env:
        RELEASE_TOKEN: ${{ secrets.RELEASE_TOKEN }}
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        git tag -a "${{ steps.version.outputs.tag }}" -m "Release version ${{ steps.version.outputs.version }}"
        git push https://x-access-token:${RELEASE_TOKEN}@github.com/${{ github.repository }}.git "${{ steps.version.outputs.tag }}"
        echo "üè∑Ô∏è  Tag ${{ steps.version.outputs.tag }} created and pushed"

  build-windows:
    needs: create-release
    if: needs.create-release.outputs.tag_exists == 'false'
    runs-on: windows-latest
    permissions:
      contents: write
      packages: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive
        ref: ${{ needs.create-release.outputs.tag }}
    
    - name: Install Qt
      uses: jurplel/install-qt-action@v4
      with:
        version: ${{ env.QT_VERSION }}
        host: 'windows'
        target: 'desktop'
        arch: 'win64_mingw'
        modules: 'qtmultimedia qt5compat'
        tools: 'tools_mingw1310,tools_openssl_x64'
    
    - name: Setup Ninja
      uses: seanmiddleditch/gha-setup-ninja@master
    
    - name: Download and setup libmpv
      run: |
        Write-Host "Downloading libmpv..."
        
        # Use GitHub Releases mirror (more reliable than SourceForge)
        $mpvUrl = "https://github.com/shinchiro/mpv-winbuild-cmake/releases/download/20251031/mpv-dev-x86_64-20251031-git-454d9eb.7z"
        $mpvArchive = "mpv-dev.7z"
        
        # Download with retry
        $maxAttempts = 3
        $attempt = 0
        $downloaded = $false
        
        while (-not $downloaded -and $attempt -lt $maxAttempts) {
            $attempt++
            try {
                Write-Host "Download attempt $attempt of $maxAttempts..."
                Invoke-WebRequest -Uri $mpvUrl -OutFile $mpvArchive -MaximumRetryCount 3
                $downloaded = $true
                Write-Host "‚úÖ Download successful"
            } catch {
                Write-Host "‚ö†Ô∏è  Attempt $attempt failed: $_"
                if ($attempt -eq $maxAttempts) {
                    throw "Failed to download libmpv after $maxAttempts attempts"
                }
                Start-Sleep -Seconds 5
            }
        }
        
        # Extract using 7zip
        Write-Host "Extracting libmpv..."
        7z x $mpvArchive -o"mpv-temp" -y
        
        # Create libs structure
        Write-Host "Setting up directory structure..."
        New-Item -ItemType Directory -Force -Path "libs/mpv/include" | Out-Null
        New-Item -ItemType Directory -Force -Path "libs/mpv/lib" | Out-Null
        New-Item -ItemType Directory -Force -Path "libs/mpv/bin" | Out-Null
        
        # Copy files to correct structure
        Write-Host "Copying files..."
        Copy-Item -Recurse -Force "mpv-temp/include/*" "libs/mpv/include/"
        Copy-Item -Force "mpv-temp/*.a" "libs/mpv/lib/" -ErrorAction SilentlyContinue
        Copy-Item -Force "mpv-temp/*.dll.a" "libs/mpv/lib/" -ErrorAction SilentlyContinue
        Copy-Item -Force "mpv-temp/*.dll" "libs/mpv/bin/" -ErrorAction SilentlyContinue
        
        # Cleanup
        Write-Host "Cleaning up..."
        Remove-Item $mpvArchive -Force
        Remove-Item -Recurse -Force mpv-temp
        
        # Verify
        Write-Host "`n‚úÖ libmpv setup complete!"
        Write-Host "Include dir exists: $(Test-Path 'libs/mpv/include/mpv/client.h')"
        if (Test-Path 'libs/mpv/lib') {
            Write-Host "Lib files: $(Get-ChildItem 'libs/mpv/lib' -Name | Out-String)"
        }
        if (Test-Path 'libs/mpv/bin') {
            Write-Host "Bin files: $(Get-ChildItem 'libs/mpv/bin' -Name | Out-String)"
        }
    
    - name: Configure CMake
      run: |
        $env:PATH = "$env:IQTA_TOOLS\mingw1310_64\bin;$env:PATH"
        $env:DISCORD_CLIENT_ID = "${{ secrets.DISCORD_CLIENT_ID }}"
        cmake -B build -G Ninja -DCMAKE_BUILD_TYPE=Release -DCMAKE_C_COMPILER=gcc -DCMAKE_CXX_COMPILER=g++
    
    - name: Build
      run: |
        $env:PATH = "$env:IQTA_TOOLS\mingw1310_64\bin;$env:PATH"
        $env:DISCORD_CLIENT_ID = "${{ secrets.DISCORD_CLIENT_ID }}"
        cmake --build build --config Release
    
    - name: Install Dependencies.exe
      run: |
        Write-Host "üì• Downloading Dependencies.exe..." -ForegroundColor Cyan
        $url = "https://github.com/lucasg/Dependencies/releases/download/v1.11.1/Dependencies_x64_Release.zip"
        $zipFile = "Dependencies.zip"
        Invoke-WebRequest -Uri $url -OutFile $zipFile
        Expand-Archive -Path $zipFile -DestinationPath "Dependencies" -Force
        Remove-Item $zipFile
        Write-Host "‚úÖ Dependencies.exe installed" -ForegroundColor Green
    
    - name: Deploy Qt dependencies
      run: |
        $ErrorActionPreference = "Continue"
        $deployDir = "build\deploy"
        
        Write-Host "Creating deploy directory..."
        New-Item -ItemType Directory -Force -Path $deployDir | Out-Null
        
        Write-Host "Copying executable..."
        Copy-Item "build\shibamusic.exe" -Destination $deployDir -Force
        
        Write-Host "Copying libmpv..."
        if (Test-Path "libs\mpv\bin\libmpv-2.dll") {
          Copy-Item "libs\mpv\bin\libmpv-2.dll" -Destination $deployDir -Force
          Write-Host "‚úÖ libmpv-2.dll copied"
        } else {
          Write-Host "‚ö†Ô∏è  libmpv-2.dll not found"
        }
        
        Write-Host "Setting up environment for windeployqt..."
        $env:PATH = "$env:QT_ROOT_DIR\bin;$env:IQTA_TOOLS\mingw1310_64\bin;$env:PATH"
        $qtBinDir = "$env:QT_ROOT_DIR\bin"
        $qtRootFullPath = [System.IO.Path]::GetFullPath($env:QT_ROOT_DIR)
        $qtParentPath = Split-Path $qtRootFullPath -Parent
        $qtGrandParentPath = Split-Path $qtParentPath -Parent
        $toolOpenSslDir = if ($qtGrandParentPath) { Join-Path $qtGrandParentPath "Tools\OpenSSL\Win_x64\bin" } else { "" }
        $openSslCandidates = @(
          (Join-Path $env:IQTA_TOOLS "OpenSSL\Win_x64\bin"),
          $toolOpenSslDir
        ) | Where-Object { $_ -and (Test-Path $_) }
        
        Write-Host "Running windeployqt..."
        $windeployqt = "$env:QT_ROOT_DIR\bin\windeployqt.exe"
        if (-not (Test-Path $windeployqt)) {
          Write-Host "‚ùå windeployqt not found at: $windeployqt"
          throw "windeployqt not found"
        }
        
        # Try windeployqt without --compiler-runtime first (simpler, less prone to errors)
        Write-Host "Attempting windeployqt without --compiler-runtime..."
        $output = & $windeployqt --qmldir qml --qmldir qml/components --qmldir qml/pages --release --no-translations --sql sqlite "$deployDir\shibamusic.exe" 2>&1
        $exitCode = $LASTEXITCODE
        
        # Show output
        $output | ForEach-Object { Write-Host $_ }
        
        # Check if deployment worked (Qt DLLs present)
        Start-Sleep -Seconds 2
        $qtDlls = Get-ChildItem $deployDir -Filter "Qt*.dll" -ErrorAction SilentlyContinue
        
        if ($qtDlls.Count -gt 0) {
          Write-Host "‚úÖ windeployqt completed successfully (found $($qtDlls.Count) Qt DLLs)"
        } else {
          Write-Host "‚ö†Ô∏è  windeployqt didn't copy Qt DLLs (exit code: $exitCode)"
          Write-Host "Trying alternative method: manual DLL copy..."
          
          # Manual copy of essential Qt DLLs (fallback)
          Write-Host "Copying Qt6 DLLs from $qtBinDir ..."
          $qtDllFiles = Get-ChildItem $qtBinDir -Filter "Qt6*.dll" -File -ErrorAction SilentlyContinue
          foreach ($file in $qtDllFiles) {
            Copy-Item $file.FullName -Destination $deployDir -Force
            Write-Host "  ‚úÖ $($file.Name)"
          }

          # Additional runtime libraries that may not follow Qt6* pattern
          $additionalDlls = @(
            "libEGL.dll",
            "libGLESv2.dll",
            "d3dcompiler_47.dll",
            "libssl-3-x64.dll",
            "libcrypto-3-x64.dll"
          )

          foreach ($dll in $additionalDlls) {
            $candidatePaths = @(
              (Join-Path $qtBinDir $dll),
              (Join-Path $env:IQTA_TOOLS "OpenSSL\Win_x64\bin\$dll"),
              (Join-Path $env:QT_ROOT_DIR "lib\$dll"),
              (Join-Path $toolOpenSslDir $dll)
            ) | Where-Object { $_ -and (Test-Path $_) }

            if ($candidatePaths.Count -gt 0) {
              Copy-Item $candidatePaths[0] -Destination $deployDir -Force
              Write-Host "  ‚úÖ $dll"
            } else {
              Write-Host "  ‚ö†Ô∏è  $dll (not found - may not be required)" -ForegroundColor DarkYellow
            }
          }
          
          # Copy plugins
          Write-Host "Copying Qt plugins..."
          $pluginsDir = "$env:QT_ROOT_DIR\plugins"
          
          # Platform plugin
          if (Test-Path "$pluginsDir\platforms") {
            New-Item -ItemType Directory -Force -Path "$deployDir\platforms" | Out-Null
            Copy-Item "$pluginsDir\platforms\qwindows.dll" -Destination "$deployDir\platforms\" -Force -ErrorAction SilentlyContinue
            Write-Host "  ‚úÖ platforms/qwindows.dll"
          }
          
          # TLS backend
          if (Test-Path "$pluginsDir\tls") {
            New-Item -ItemType Directory -Force -Path "$deployDir\tls" | Out-Null
            Copy-Item "$pluginsDir\tls\*" -Destination "$deployDir\tls\" -Force -ErrorAction SilentlyContinue
            Write-Host "  ‚úÖ tls plugins"
          }
          
          # Image formats
          if (Test-Path "$pluginsDir\imageformats") {
            New-Item -ItemType Directory -Force -Path "$deployDir\imageformats" | Out-Null
            $imagePlugins = @("qgif.dll", "qicns.dll", "qico.dll", "qjpeg.dll", "qsvg.dll", "qwebp.dll")
            foreach ($plugin in $imagePlugins) {
              $pluginPath = "$pluginsDir\imageformats\$plugin"
              if (Test-Path $pluginPath) {
                Copy-Item $pluginPath -Destination "$deployDir\imageformats\" -Force -ErrorAction SilentlyContinue
              }
            }
            Write-Host "  ‚úÖ imageformats plugins"
          }
          
          # Generic plugins
          if (Test-Path "$pluginsDir\generic") {
            New-Item -ItemType Directory -Force -Path "$deployDir\generic" | Out-Null
            Copy-Item "$pluginsDir\generic\*" -Destination "$deployDir\generic\" -Force -ErrorAction SilentlyContinue
            Write-Host "  ‚úÖ generic plugins"
          }
          
          # Styles
          if (Test-Path "$pluginsDir\styles") {
            New-Item -ItemType Directory -Force -Path "$deployDir\styles" | Out-Null
            Copy-Item "$pluginsDir\styles\*" -Destination "$deployDir\styles\" -Force -ErrorAction SilentlyContinue
            Write-Host "  ‚úÖ styles plugins"
          }
          
          # Copy QML modules
          Write-Host "Copying essential QML modules..."
          $qmlSrcDir = "$env:QT_ROOT_DIR\qml"
          $qmlDstDir = "$deployDir\qml"
          $qmlModules = @(
            "QtCore",
            "QtQuick",
            "QtQuick.2",
            "QtQml",
            "QtQml.Models",
            "QtQml.WorkerScript",
            "QtQml.XmlListModel",
            "QtQuick.Controls",
            "QtQuick.Controls.Basic",
            "QtQuick.Controls.Material",
            "QtQuick.Controls.Fusion",
            "QtQuick.Controls.Imagine",
            "QtQuick.Controls.Universal",
            "QtQuick.Controls.impl",
            "QtQuick.Dialogs",
            "QtQuick.Layouts",
            "QtQuick.LocalStorage",
            "QtQuick.NativeStyle",
            "QtQuick.Particles",
            "QtQuick.Templates",
            "QtQuick.Window",
            "QtQuick.Shapes",
            "QtQuick.Effects"
          )
          
          foreach ($module in $qmlModules) {
            # Handle module paths with dots (e.g., QtQuick.Controls)
            $modulePath = $module.Replace('.', '\')
            $srcPath = Join-Path $qmlSrcDir $modulePath
            
            if (Test-Path $srcPath) {
              $dstPath = Join-Path $qmlDstDir $modulePath
              $dstParent = Split-Path $dstPath -Parent
              
              # Create parent directories
              if ($dstParent) {
                New-Item -ItemType Directory -Force -Path $dstParent -ErrorAction SilentlyContinue | Out-Null
              }
              
              # Copy entire module directory
              Copy-Item $srcPath -Destination $dstPath -Recurse -Force -ErrorAction SilentlyContinue
              Write-Host "  ‚úÖ $module"
            } else {
              Write-Host "  ‚ö†Ô∏è  $module (not found)" -ForegroundColor DarkGray
            }
          }
          
          Write-Host "‚úÖ Manual deployment completed"
        }
        
        Write-Host "`nEnsuring TLS/OpenSSL runtime libraries..."
        $opensslLibs = @("libssl-3-x64.dll", "libcrypto-3-x64.dll")
        $opensslSearchDirs = @($qtBinDir) + $openSslCandidates
        foreach ($lib in $opensslLibs) {
          $targetPath = Join-Path $deployDir $lib
          if (-not (Test-Path $targetPath)) {
            $copied = $false
            foreach ($dir in $opensslSearchDirs) {
              if (-not $dir) { continue }
              $sourcePath = Join-Path $dir $lib
              if (Test-Path $sourcePath) {
                Copy-Item $sourcePath -Destination $targetPath -Force
                Write-Host "  ‚úÖ $lib copied from $dir"
                $copied = $true
                break
              }
            }
            if (-not $copied) {
              Write-Host "  ‚ö†Ô∏è  $lib not found in configured OpenSSL directories" -ForegroundColor DarkYellow
            }
          } else {
            Write-Host "  ‚úÖ $lib already present"
          }
        }

        $tlsPluginSource = Join-Path "$env:QT_ROOT_DIR\plugins" "tls"
        $tlsPluginDest = Join-Path $deployDir "tls"
        if (Test-Path $tlsPluginSource) {
          if (-not (Test-Path $tlsPluginDest)) {
            New-Item -ItemType Directory -Force -Path $tlsPluginDest | Out-Null
          }
          Copy-Item "$tlsPluginSource\*" -Destination $tlsPluginDest -Force -ErrorAction SilentlyContinue
          Write-Host "  ‚úÖ TLS plugins ensured"
        } else {
          Write-Host "  ‚ö†Ô∏è  TLS plugins directory not found at $tlsPluginSource" -ForegroundColor DarkYellow
        }

        Write-Host "Copying MinGW runtime DLLs..."
        $mingwPath = "$env:IQTA_TOOLS\mingw1310_64\bin"
        $dllsToCheck = @(
          "libgcc_s_seh-1.dll",
          "libstdc++-6.dll",
          "libwinpthread-1.dll"
        )
        
        foreach ($dll in $dllsToCheck) {
          $dllPath = Join-Path $mingwPath $dll
          if (Test-Path $dllPath) {
            Copy-Item $dllPath -Destination $deployDir -Force
            Write-Host "  ‚úÖ $dll"
          } else {
            Write-Host "  ‚ö†Ô∏è  $dll not found"
          }
        }
        
        Write-Host "`n‚úÖ Deployment complete!"
        Write-Host "Deploy directory contents:"
        try {
          Get-ChildItem $deployDir -Name -ErrorAction Stop | ForEach-Object { Write-Host "  - $_" }
        } catch {
          Write-Host "Could not list directory contents: $_"
        }
        
        # Ensure success
        exit 0
    
    - name: Verify dependencies with Dependencies.exe
      run: |
        Write-Host "`nüîç Verifying DLL dependencies..." -ForegroundColor Cyan
        Write-Host "=" * 70
        
        $deployDir = "build\deploy"
        $exePath = "$deployDir\shibamusic.exe"
        $depsExe = "Dependencies\DependenciesGui.exe"
        $depsCli = "Dependencies\Dependencies.exe"
        
        # Check if CLI version exists
        if (Test-Path $depsCli) {
          Write-Host "‚úÖ Using Dependencies CLI" -ForegroundColor Green
          
          # Run dependency check
          & $depsCli -imports $exePath | Out-File "dependency-report.txt"
          
          # Parse output to find missing DLLs
          $report = Get-Content "dependency-report.txt" -Raw
          
          if ($report -match "missing|not found") {
            Write-Host "‚ö†Ô∏è  Some dependencies may be missing!" -ForegroundColor Yellow
            Write-Host $report
          } else {
            Write-Host "‚úÖ All dependencies appear to be satisfied" -ForegroundColor Green
          }
          
          # Show key Qt DLLs
          Write-Host "`nüì¶ Qt DLLs in deployment:" -ForegroundColor Cyan
          Get-ChildItem $deployDir -Filter "Qt6*.dll" | ForEach-Object {
            Write-Host "  ‚úÖ $($_.Name)" -ForegroundColor Green
          }
          
        } else {
          Write-Host "‚ö†Ô∏è  Dependencies CLI not available, using manual check" -ForegroundColor Yellow
          
          # Manual check of essential DLLs
          $essentialChecks = @(
            "Qt6Core.dll",
            "Qt6Gui.dll",
            "Qt6Qml.dll",
            "Qt6QmlCore.dll",
            "Qt6Sql.dll",
            "Qt6Quick.dll",
            "Qt6QuickControls2.dll",
            "Qt6QuickControls2Impl.dll",
            "Qt6QuickTemplates2.dll",
            "libmpv-2.dll",
            "libssl-3-x64.dll",
            "libcrypto-3-x64.dll",
            "tls\opensslbackend.dll"
          )
          
          Write-Host "`nüì¶ Checking essential DLLs:" -ForegroundColor Cyan
          $allPresent = $true
          foreach ($dll in $essentialChecks) {
            $dllPath = Join-Path $deployDir $dll
            if (Test-Path $dllPath) {
              Write-Host "  ‚úÖ $dll" -ForegroundColor Green
            } else {
              Write-Host "  ‚ùå $dll - MISSING!" -ForegroundColor Red
              $allPresent = $false
            }
          }

          # Ensure SQL driver plugins are included
          $qtPluginsDir = Join-Path $env:QT_ROOT_DIR "plugins"
          $sourceSqlDir = Join-Path $qtPluginsDir "sqldrivers"
          $destSqlDir = Join-Path $deployDir "sqldrivers"
          if (Test-Path $sourceSqlDir) {
            Write-Host "`nüì¶ Ensuring SQL driver plugins are deployed..." -ForegroundColor Cyan
            if (-not (Test-Path $destSqlDir)) {
              New-Item -ItemType Directory -Path $destSqlDir -Force | Out-Null
            }
            Copy-Item (Join-Path $sourceSqlDir "*") -Destination $destSqlDir -Recurse -Force
            Write-Host "  ‚úÖ SQL drivers copied to $(Resolve-Path $destSqlDir)" -ForegroundColor Green
          } else {
            Write-Host "`n‚ö†Ô∏è  SQL driver plugins directory not found at $sourceSqlDir" -ForegroundColor Yellow
            $allPresent = $false
          }
          
          # Check QML modules
          Write-Host "`nüì¶ Checking essential QML modules:" -ForegroundColor Cyan
          $qmlDir = "$deployDir\qml"
          $essentialModules = @(
            "QtQuick\Controls\Material",
            "QtQuick\Controls\impl"
          )
          
          foreach ($module in $essentialModules) {
            $modulePath = Join-Path $qmlDir $module
            if (Test-Path $modulePath) {
              Write-Host "  ‚úÖ $module" -ForegroundColor Green
            } else {
              Write-Host "  ‚ùå $module - MISSING!" -ForegroundColor Red
              $allPresent = $false
            }
          }
          
          if ($allPresent) {
            Write-Host "`n‚úÖ All essential dependencies present!" -ForegroundColor Green
          } else {
            Write-Host "`n‚ö†Ô∏è  Some dependencies are missing!" -ForegroundColor Yellow
            Write-Host "The app may not work correctly." -ForegroundColor Yellow
          }
        }
        
        Write-Host "=" * 70
    
    - name: Create archive
      run: |
        Compress-Archive -Path "build\deploy\*" -DestinationPath "ShibaMusic-Windows-x64.zip"
    
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: ShibaMusic-Windows
        path: ShibaMusic-Windows-x64.zip
    
    - name: Upload dependency report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: Dependency-Report
        path: |
          dependency-report.txt
          check-dlls.ps1
        if-no-files-found: ignore
    
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ needs.create-release.outputs.tag }}
        name: Release ${{ needs.create-release.outputs.version }}
        body: |
          ## Shiba Music ${{ needs.create-release.outputs.version }}
          
          ### üì¶ Downloads
          
          - **Windows (x64)**: ShibaMusic-Windows-x64.zip
          
          ### üìù Installation
          
          1. Download the ZIP file
          2. Extract to a folder
          3. Run `shibamusic.exe`
          
          ### ‚ú® What's New
          
          See [CHANGELOG.md](https://github.com/${{ github.repository }}/blob/main/CHANGELOG.md) for details.
          
          ---
          
          **Full Changelog**: https://github.com/${{ github.repository }}/compare/v${{ needs.create-release.outputs.version }}...HEAD
        files: ShibaMusic-Windows-x64.zip
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.RELEASE_TOKEN }}
