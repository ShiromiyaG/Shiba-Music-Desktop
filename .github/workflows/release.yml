name: Build and Release

on:
  push:
    branches:
      - main
      - master
    paths:
      - 'version.txt'

env:
  QT_VERSION: '6.9.3'
  DISCORD_CLIENT_ID: ${{ secrets.DISCORD_CLIENT_ID }}

jobs:
  create-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write
    outputs:
      version: ${{ steps.version.outputs.version }}
      tag: ${{ steps.version.outputs.tag }}
      tag_exists: ${{ steps.check_tag.outputs.exists }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Read version
      id: version
      run: |
        VERSION=$(cat version.txt | tr -d '\n' | tr -d '\r')
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "tag=v$VERSION" >> $GITHUB_OUTPUT
        echo "üì¶ Version: $VERSION"
    
    - name: Check if tag exists
      id: check_tag
      run: |
        if git rev-parse "v${{ steps.version.outputs.version }}" >/dev/null 2>&1; then
          echo "exists=true" >> $GITHUB_OUTPUT
          echo "‚ö†Ô∏è  Tag v${{ steps.version.outputs.version }} already exists"
        else
          echo "exists=false" >> $GITHUB_OUTPUT
          echo "‚úÖ Tag v${{ steps.version.outputs.version }} is new"
        fi
    
    - name: Create and push tag
      if: steps.check_tag.outputs.exists == 'false'
      env:
        RELEASE_TOKEN: ${{ secrets.RELEASE_TOKEN }}
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        git tag -a "${{ steps.version.outputs.tag }}" -m "Release version ${{ steps.version.outputs.version }}"
        git push https://x-access-token:${RELEASE_TOKEN}@github.com/${{ github.repository }}.git "${{ steps.version.outputs.tag }}"
        echo "üè∑Ô∏è  Tag ${{ steps.version.outputs.tag }} created and pushed"

  build-windows:
    needs: create-release
    if: needs.create-release.outputs.tag_exists == 'false'
    runs-on: windows-latest
    permissions:
      contents: write
      packages: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive
        ref: ${{ needs.create-release.outputs.tag }}
    
    - name: Install Qt
      uses: jurplel/install-qt-action@v4
      with:
        version: ${{ env.QT_VERSION }}
        host: 'windows'
        target: 'desktop'
        arch: 'win64_mingw'
        modules: 'qtmultimedia qt5compat'
        tools: 'tools_mingw1310'
    
    - name: Setup Ninja
      uses: seanmiddleditch/gha-setup-ninja@master
    
    - name: Download and setup libmpv
      run: |
        Write-Host "Downloading libmpv..."
        
        # Use GitHub Releases mirror (more reliable than SourceForge)
        $mpvUrl = "https://github.com/shinchiro/mpv-winbuild-cmake/releases/download/20251031/mpv-dev-x86_64-20251031-git-454d9eb.7z"
        $mpvArchive = "mpv-dev.7z"
        
        # Download with retry
        $maxAttempts = 3
        $attempt = 0
        $downloaded = $false
        
        while (-not $downloaded -and $attempt -lt $maxAttempts) {
            $attempt++
            try {
                Write-Host "Download attempt $attempt of $maxAttempts..."
                Invoke-WebRequest -Uri $mpvUrl -OutFile $mpvArchive -MaximumRetryCount 3
                $downloaded = $true
                Write-Host "‚úÖ Download successful"
            } catch {
                Write-Host "‚ö†Ô∏è  Attempt $attempt failed: $_"
                if ($attempt -eq $maxAttempts) {
                    throw "Failed to download libmpv after $maxAttempts attempts"
                }
                Start-Sleep -Seconds 5
            }
        }
        
        # Extract using 7zip
        Write-Host "Extracting libmpv..."
        7z x $mpvArchive -o"mpv-temp" -y
        
        # Create libs structure
        Write-Host "Setting up directory structure..."
        New-Item -ItemType Directory -Force -Path "libs/mpv/include" | Out-Null
        New-Item -ItemType Directory -Force -Path "libs/mpv/lib" | Out-Null
        New-Item -ItemType Directory -Force -Path "libs/mpv/bin" | Out-Null
        
        # Copy files to correct structure
        Write-Host "Copying files..."
        Copy-Item -Recurse -Force "mpv-temp/include/*" "libs/mpv/include/"
        Copy-Item -Force "mpv-temp/*.a" "libs/mpv/lib/" -ErrorAction SilentlyContinue
        Copy-Item -Force "mpv-temp/*.dll.a" "libs/mpv/lib/" -ErrorAction SilentlyContinue
        Copy-Item -Force "mpv-temp/*.dll" "libs/mpv/bin/" -ErrorAction SilentlyContinue
        
        # Cleanup
        Write-Host "Cleaning up..."
        Remove-Item $mpvArchive -Force
        Remove-Item -Recurse -Force mpv-temp
        
        # Verify
        Write-Host "`n‚úÖ libmpv setup complete!"
        Write-Host "Include dir exists: $(Test-Path 'libs/mpv/include/mpv/client.h')"
        if (Test-Path 'libs/mpv/lib') {
            Write-Host "Lib files: $(Get-ChildItem 'libs/mpv/lib' -Name | Out-String)"
        }
        if (Test-Path 'libs/mpv/bin') {
            Write-Host "Bin files: $(Get-ChildItem 'libs/mpv/bin' -Name | Out-String)"
        }
    
    - name: Configure CMake
      run: |
        $env:PATH = "$env:IQTA_TOOLS\mingw1310_64\bin;$env:PATH"
        $env:DISCORD_CLIENT_ID = "${{ secrets.DISCORD_CLIENT_ID }}"
        cmake -B build -G Ninja -DCMAKE_BUILD_TYPE=Release -DCMAKE_C_COMPILER=gcc -DCMAKE_CXX_COMPILER=g++
    
    - name: Build
      run: |
        $env:PATH = "$env:IQTA_TOOLS\mingw1310_64\bin;$env:PATH"
        $env:DISCORD_CLIENT_ID = "${{ secrets.DISCORD_CLIENT_ID }}"
        cmake --build build --config Release
    
    - name: Deploy Qt dependencies
      run: |
        $ErrorActionPreference = "Continue"
        $deployDir = "build\deploy"
        
        Write-Host "Creating deploy directory..."
        New-Item -ItemType Directory -Force -Path $deployDir | Out-Null
        
        Write-Host "Copying executable..."
        Copy-Item "build\shibamusic.exe" -Destination $deployDir -Force
        
        Write-Host "Copying libmpv..."
        if (Test-Path "libs\mpv\bin\libmpv-2.dll") {
          Copy-Item "libs\mpv\bin\libmpv-2.dll" -Destination $deployDir -Force
          Write-Host "‚úÖ libmpv-2.dll copied"
        } else {
          Write-Host "‚ö†Ô∏è  libmpv-2.dll not found"
        }
        
        Write-Host "Setting up environment for windeployqt..."
        $env:PATH = "$env:QT_ROOT_DIR\bin;$env:IQTA_TOOLS\mingw1310_64\bin;$env:PATH"
        
        Write-Host "Running windeployqt..."
        $windeployqt = "$env:QT_ROOT_DIR\bin\windeployqt.exe"
        if (-not (Test-Path $windeployqt)) {
          Write-Host "‚ùå windeployqt not found at: $windeployqt"
          throw "windeployqt not found"
        }
        
        # Try windeployqt without --compiler-runtime first (simpler, less prone to errors)
        Write-Host "Attempting windeployqt without --compiler-runtime..."
        $output = & $windeployqt --qmldir qml --release --no-translations "$deployDir\shibamusic.exe" 2>&1
        $exitCode = $LASTEXITCODE
        
        # Show output
        $output | ForEach-Object { Write-Host $_ }
        
        # Check if deployment worked (Qt DLLs present)
        Start-Sleep -Seconds 2
        $qtDlls = Get-ChildItem $deployDir -Filter "Qt*.dll" -ErrorAction SilentlyContinue
        
        if ($qtDlls.Count -gt 0) {
          Write-Host "‚úÖ windeployqt completed successfully (found $($qtDlls.Count) Qt DLLs)"
        } else {
          Write-Host "‚ö†Ô∏è  windeployqt didn't copy Qt DLLs (exit code: $exitCode)"
          Write-Host "Trying alternative method: manual DLL copy..."
          
          # Manual copy of essential Qt DLLs
          $qtBinDir = "$env:QT_ROOT_DIR\bin"
          $essentialDlls = @(
            "Qt6Core.dll",
            "Qt6Gui.dll",
            "Qt6Network.dll",
            "Qt6Qml.dll",
            "Qt6Quick.dll",
            "Qt6QuickControls2.dll",
            "Qt6QmlModels.dll",
            "Qt6OpenGL.dll",
            "Qt6Widgets.dll"
          )
          
          foreach ($dll in $essentialDlls) {
            $dllPath = Join-Path $qtBinDir $dll
            if (Test-Path $dllPath) {
              Copy-Item $dllPath -Destination $deployDir -Force
              Write-Host "  ‚úÖ $dll"
            }
          }
          
          # Copy plugins
          Write-Host "Copying Qt plugins..."
          $pluginsDir = "$env:QT_ROOT_DIR\plugins"
          if (Test-Path "$pluginsDir\platforms") {
            New-Item -ItemType Directory -Force -Path "$deployDir\platforms" | Out-Null
            Copy-Item "$pluginsDir\platforms\qwindows.dll" -Destination "$deployDir\platforms\" -Force -ErrorAction SilentlyContinue
            Write-Host "  ‚úÖ platforms/qwindows.dll"
          }
          
          # Copy QML modules
          Write-Host "Copying essential QML modules..."
          $qmlSrcDir = "$env:QT_ROOT_DIR\qml"
          $qmlDstDir = "$deployDir\qml"
          $qmlModules = @("QtQuick", "QtQuick.2", "QtQml")
          
          foreach ($module in $qmlModules) {
            $srcPath = Join-Path $qmlSrcDir $module
            if (Test-Path $srcPath) {
              $dstPath = Join-Path $qmlDstDir $module
              New-Item -ItemType Directory -Force -Path $dstPath | Out-Null
              Copy-Item "$srcPath\*" -Destination $dstPath -Recurse -Force -ErrorAction SilentlyContinue
              Write-Host "  ‚úÖ $module"
            }
          }
          
          Write-Host "‚úÖ Manual deployment completed"
        }
        
        Write-Host "Copying MinGW runtime DLLs..."
        $mingwPath = "$env:IQTA_TOOLS\mingw1310_64\bin"
        $dllsToCheck = @(
          "libgcc_s_seh-1.dll",
          "libstdc++-6.dll",
          "libwinpthread-1.dll"
        )
        
        foreach ($dll in $dllsToCheck) {
          $dllPath = Join-Path $mingwPath $dll
          if (Test-Path $dllPath) {
            Copy-Item $dllPath -Destination $deployDir -Force
            Write-Host "  ‚úÖ $dll"
          } else {
            Write-Host "  ‚ö†Ô∏è  $dll not found"
          }
        }
        
        Write-Host "`n‚úÖ Deployment complete!"
        Write-Host "Deploy directory contents:"
        try {
          Get-ChildItem $deployDir -Name -ErrorAction Stop | ForEach-Object { Write-Host "  - $_" }
        } catch {
          Write-Host "Could not list directory contents: $_"
        }
        
        # Ensure success
        exit 0
    
    - name: Create archive
      run: |
        Compress-Archive -Path "build\deploy\*" -DestinationPath "ShibaMusic-Windows-x64.zip"
    
    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: ShibaMusic-Windows
        path: ShibaMusic-Windows-x64.zip
    
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ needs.create-release.outputs.tag }}
        name: Release ${{ needs.create-release.outputs.version }}
        body: |
          ## Shiba Music ${{ needs.create-release.outputs.version }}
          
          ### üì¶ Downloads
          
          - **Windows (x64)**: ShibaMusic-Windows-x64.zip
          
          ### üìù Installation
          
          1. Download the ZIP file
          2. Extract to a folder
          3. Run `shibamusic.exe`
          
          ### ‚ú® What's New
          
          See [CHANGELOG.md](https://github.com/${{ github.repository }}/blob/main/CHANGELOG.md) for details.
          
          ---
          
          **Full Changelog**: https://github.com/${{ github.repository }}/compare/v${{ needs.create-release.outputs.version }}...HEAD
        files: ShibaMusic-Windows-x64.zip
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.RELEASE_TOKEN }}
